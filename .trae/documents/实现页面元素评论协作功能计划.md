# 页面元素评论协作功能实现计划 (含导入导出)

该计划旨在为当前原型增加类似 Figma/Linear 的"评论协作模式"，允许用户对页面元素进行打点评论，并支持数据的导入导出以便分享协作。

## 1. 功能设计 (UI/UX)
风格严格遵循 **Linear (Precision & Engineered)** 设计语言。

### 1.1 协作工具栏 (Floating Toolbar)
*   **位置**: 页面右下角悬浮。
*   **功能区**:
    *   **评论开关**: 切换 "浏览模式" / "评论模式" (快捷键 `C`)。
    *   **导出数据**: 下载当前所有评论为 JSON 文件。
    *   **导入数据**: 上传 JSON 文件恢复评论。
    *   **清除所有**: (可选) 快速重置。
*   **样式**: 胶囊式设计，磨砂玻璃背景，微光边框，内部包含分隔线。

### 1.2 元素选择与高亮
*   **交互**: 评论模式下，鼠标悬停元素显示蓝色边框 (`2px solid var(--color-accent)`) 和半透明遮罩。
*   **屏蔽**: 禁用点击元素时的默认跳转行为 (`preventDefault`)。

### 1.3 评论交互
*   **输入框 (Popover)**: 点击元素后弹出，包含输入框和发送/取消按钮。
*   **评论标记 (Pins)**: 带有序号的小圆点，吸附在元素右上角。悬停或点击 Pin 可查看/删除评论。

## 2. 技术实现方案

### 2.1 数据存储 (Schema)
使用 `localStorage` 持久化，并作为导入导出的数据源。
```javascript
interface CommentData {
  version: "1.0",
  url: string; // 记录来源页面 URL (可选)
  comments: Array<{
    id: string;
    selector: string; // 元素的唯一选择器 (CSS Path)
    content: string;
    timestamp: number;
    author: string;
    position: { x: number, y: number }; // 相对元素的位置偏移
  }>
}
```

### 2.2 核心模块 (`js/comments.js`)
扩展 `CommentSystem` 类：
1.  **`toggleMode()`**: 切换模式，控制 DOM 事件捕获。
2.  **`highlightElement(target)`**: 绘制高亮框。
3.  **`addComment(element, text)`**: 保存评论并渲染 Pin。
4.  **`exportData()`**: 将 `comments` 数组转为 JSON Blob 并触发浏览器下载。
5.  **`importData(file)`**: 读取文件内容，解析 JSON，合并/覆盖 LocalStorage，并重新渲染 Pins。

## 3. 实施步骤

### Phase 1: 基础架构与样式
1.  创建 `css/comments.css`: 定义 Pins, Popovers, Toolbar 的 Linear 风格样式。
2.  创建 `js/comments.js`: 初始化 `CommentSystem` 类。
3.  在 `index.html` 中引入新文件。

### Phase 2: 交互逻辑 (选择与高亮)
1.  实现悬浮工具栏 UI。
2.  实现 "评论模式" 下的 `mouseover` 高亮和 `click` 拦截逻辑。
3.  实现简单的 CSS 选择器生成算法 (用于定位元素)。

### Phase 3: 评论核心功能
1.  实现评论输入框的弹出与定位。
2.  实现评论数据的增删改查 (CRUD) 及 LocalStorage 同步。
3.  实现 Pin 的渲染逻辑 (页面加载时自动恢复)。

### Phase 4: 导入导出功能
1.  实现 **导出**: 点击按钮 -> 生成 `comments.json` -> 触发下载。
2.  实现 **导入**: 点击按钮 -> 触发隐藏的 `<input type="file">` -> 读取并解析 -> 刷新界面。

请确认此更新后的计划？